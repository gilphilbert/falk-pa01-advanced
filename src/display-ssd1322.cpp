#include "display-ssd1322.h"

#include "falk-pre-conf.h"

// THIS BLOCK NEEDED FOR THE DISPLAY
#include <SPI.h>
#include "U8g2lib.h"
// ^^ \libraries\U8g2\src\clib\u8g2.h <-- uncomment #define U8G2_16BIT


// this is the rubik font (size 24)
const uint8_t rubik_24_f[4617] U8G2_FONT_SECTION("rubik_24_f") = 
  "\277\0\4\4\5\5\3\5\6\27\33\377\373\21\373\23\374\2\334\5\272\21\354 \6\0\60\232\0!\11#"
  "\32\232\360\201\261\4\42\13\310t\253\60\304&\362\2\0#\42\356\65\306%F\330\30ac\304\264\350H"
  "\214\260\61\302\306\10\33C\342A\33\61\243\306\10\33#\10\0$\42\256\326\275\65v\344\261DKH\221"
  " \66\202,Qt\11Q\226\35\61\16\331\210&\253\20\216\35\6\0%\63\61\26\316Bn\210\251!C"
  "D\211\221h\214\64\203\304\10\31\65D\272\42#\205\214\11\71\302\234\220\21\243\206\210\21\64F\232Ab"
  "\244\22\62\225\221qD\0&&\60\26\306T\364 \11rc\306\215\31\67f\34J\253\204\240\31\62\204"
  "\310\210AGF\31!E\210\310\31Gf\10'\10\303t\233\300B\2(\27\347\226\245%\206H\11\62"
  "\203\6\11\232\177%j\320 BeH\11)\25\346\226\245\20\212H\231Ac\346H\336\314\223\21%\210"
  "\10\2*\26)\65\257#nP\10!!P$!\64b\310\10AA\302\0+\17\255\65\276%v\350"
  "\134=X\65t\256\0,\13\304\324\231\61B\305\10!\0-\10h\330\262\360 \1.\7\204\24\232\361"
  "\0/\33\253\326\261\70n\340@\201\323\15\34(p\272\201\343\6\16\24\70\335\300\201\42\1\60\30-\26"
  "\302d*\221\22B$\206\335\317F\14\33A\210\304\32Eg\0\61\22)\22\256\66\212\214\221\23$\216"
  "\214\20\63l\376\3\62\27-\26\276d*\315\222A$H\215 \65\222Br\365\356\301\203\4\63\26-"
  "\26\276\261d\313\271\64\207\260(Qs\247\36\4Yt\6\0\64\36.\26\302G\262Bs#\306\215\30"
  "\66d\324\230Ad\6M\63j\314\203\206cg\3\0\65\31-\26\276\242d\223\241\263 \245f\311("
  "\222$\217\241\42\261D\325\31\0\66\33-\26\276Fr$A*G\246YB\206\4\251s\346\216\235\42"
  "\261&\325\31\0\67\31+\26\266\360\301\300q\344\306\221\33Gn\340\70r\343\310\215#\67\14\0\70 "
  ".\26\302dL\315\232QD\206\15\31\66\204\320 mJ\230 \66\202\30fC\252Q\205\6\0\71\33"
  "-\26\276c,\315\12B$\206]\206\212\4\31\42\212\22\222\34I\220\312q\0:\11\203\31\236\300\36"
  "@\2;\17\304\325\235\61\367`DL!b\204\20\0<\25\352\65\262\31n\30\241\212\10\225\32W\254"
  "\34\271r\344F\6=\13\12y\272\360\240<\244\17\12>\27\351\71\262\20P\334\260R\305J\25\33E"
  "\246\14\231B\303\304\5\4\77\27,\26\272cH\211\12B\247N\221\243!\71\202\344!!H\21\0@"
  "\64r\266\321\205\220\25\271AB\207\10\26\42\346\210\21\64d\304\214!#H\14\31Ab\310\10\22C"
  "F\314\20#L\304\224 #\36\210\320\61\304H\261<\5\0A!\60\22\306F\270lQ\243#\6\222"
  "\30\70\204\334\230a\203\206\215\232\21\243&N\6\222\30yr\0B\30-\32\302\240\206\5\213a\67{"
  "\20b\11\213a\347,{\340B\15\0C\31.\26\302tJ\321\22R$\306]J\357F\214\33A\212"
  "D\223Ug\0D\37.\32\306\220j\15\223a$\306\215\30\67b\334\210qw\67b\334\210a$\230"
  "\60Q\4\0E\22,\32\276\260\342\1\313Y\256\330b\344,\37<\60F\16+\32\272\360\201\301\71|"
  "\240p>\4G\34/\26\306tl\21\23RD\306\215 K\243\355\320\221\30\67\204\24\221\66\313\16\1"
  "H\17.\32\312\60\356\276{\360\1\271\373\216\0I\10#\32\236\360\3\3J\22-\26\302\301K\372\345"
  "\261c\250F\60Qu\6\0K&-\32\276\60l\304(\22\203\210\214!\63\204\320\10R\307\314\231;"
  "\206jD\241!\204\306\220\31Dd\24\211a\4L\15+\32\272\60p\376\37>x\60\0M \60\32"
  "\316\60T\4At\312T\61b\243b\210\212)\216\230\70R\344\14\221\63cN\336\222\0N\34-\32"
  "\306\60\356\330\61T\211\22\251\61\61\306\310\20#$\314\214\60\224\25\262\353\6O\31.\26\306dL\321"
  "\22R$\206\241\273\357F\214\33A\212\4\233Ug\0P\26-\32\302\220h\11\213a\327\31;\366 "
  "\304\222DC\347)\0Q\32n\326\305dL\321\22R$\206\241\273\357F\214\33A\212\4\233Ui\311"
  "\16R\34-\32\302\220h\11\213aw\365@\304\22\65\203\210\214\32\62\212\304\260\21\303\316\15S\35."
  "\26\276s,\321\22R$\210\215 K\24]B\224eG\214C\66\242\311*\64\0T\15-\26\276\360"
  "A\252\241\363\377\12\0U\20-\32\306\60\316\376\357N\221X\262\350\14\0V%/\26\302\60\360\340\10"
  "rC\206\21\31\66\206\324\240A\204\246\42\63l\10\261!\343H\14<h\322hQb\0W\62\62\26"
  "\322\60\330,\322\21D\207\214\31\64d\14\21\42c\210\20\31Rd\14\211\42\203F\210\230\310\210\210A"
  "F\14\225)U\210T!b\243\210M\3\0X!/\22\302\61p\4\61\42\204\10ME\204\30B\223"
  "F\211\32<\210\214\10!j\10\21!\206p\0Y\32.\26\302\60\320\340\261!\204\310\14\32D\204\324"
  "\220a\350\14\232$J_\1Z\24-\26\276\360AB\202\5iX\220\206\5\11>x\220\0[\15\346"
  "\232\245\360\300\314\374\377\315\203\1\134\35\253\326\261 r\340\310\201#E\16\34\71p\244\310\201#\7\216"
  "\34\70R\344\300\221\3]\15\346\226\245\360`\314\374\377\315\3\3^\13\210\324\257\24\212\214\211\61\2_"
  "\10P\364\311\360\201\0`\12\205\330\247\60\204\314\30\1a\24\253\25\272\64\14\211\212A\3G\31qc"
  "\312\242\27&\6b\31,\32\276\60rN\6)YA\206\304\250\21\243\356jD\25JF\224\1c\25"
  "\254\25\272\64\16\215\222A\210N\316\222\20\11\42D\24\231\1d\30,\26\276\71Gb\206\250X\61\10"
  "\225\61\233\35\42A\244\304\22\23\3e\27\254\25\272D\14\215\222A#F\35{\360\222\324\210Ac\22"
  "\231\1f\22J\22\252F\310\314\231q\23=(\63n\376\21\0g\36Lv\275\64\316\304\210\25\203P"
  "\31\263\354\324!\22K\324\20\31yj\4\31\22\212\216\0h\22,\32\276\60rn\4)YA\206\304"
  "\250\373+\2i\12$\26\232\200z\304\374\17j\17\306n\235\63=\260\61\363\177\362B\20\0k\33+"
  "\32\266\60p\336\220\30Bd\4\231C\246\254:\64\202\314\20\42cH\14\42l\10#\32\232\360\3\3"
  "m#\262\31\332\65hL\22\23\17\14\221\71D\310\320(C\243\14\215\62\64\312\320(C\243\14\215\62"
  "\64j\0n\23\254\31\276\65H\311\12\62$F\215\30u\277\32\1\0o\25\254\25\272D\14\215\222A"
  "\250\214\331\354\20\11\62C\24\231\1p\32Lz\275\65H\311\12\62$F\215\30uW#\252P\62\242"
  "\314\310Y\12\5q\30Lv\275\64N\305\212A\250\214Yv\352\20\11\42%\226\230\30\71\17r\14\210"
  "\31\252\360\300\314\250\371+\0s\26\253\25\266C\12M\212Q\42\10\26Cu\220\340\31\22i\216\0t"
  "\21*\22\252\63n\216\36\224\31\67\337\35\62U\0u\21\214\25\276@\352~\65b\324\10\42%\326\224"
  "\30v\32\214\25\272\60\314\24\211AC\6\15\31\63h\310\240!\243\214\31+H\21\0w&\222\25\322"
  "\60h\224!B\206\310\14\31Rf\310\20#\223\210\230\310\210\210AF\14\225)F\210\30!b\243\6"
  "\1x\33\214\25\272@\210\304\30\62C\6\35\63G\256\330\251\21d\306\220 \64b\330\0y ,v"
  "\271\60\314\330\210AC\6\15!\62h\310\240\21\244\214\231#Hp\344@\202#\7\216\3z\20\213\25"
  "\266\240B\35\61\332\21\243L\305\203\3{\30\351\222\251\30\212P\31R\303\346j\24!b\304\246\33\66"
  "w\205\312\11|\10b{\231\360\203\4}\31\350\226\251\20\216P\251a\243\346\31\251Ad\10\215\232\243"
  "\61e\10\11\3~\13\212\270\266P\350\301)!\0\240\6\0\60\232\0\241\12\4\226\231\300j\304\374\17"
  "\242\32,\326\271%r$\61\64J\6\241\62\71KB$\210\220Idn\344(\0\243!/\26\306e"
  "\60\325\32BdH\215\31\66f\360PU\12\7O&\344\320\210\26cP\214*\2\0\244\36\214\65\272"
  "!DL\10\26J\6\15\21&D\330\10a#F\211\31B\304\5\212\200!\0\245\35.\26\302\60\360"
  "\30\211QD\10MC\210\310\260\21\304\16\232Z\263H\233\355\210\16\3\246\12\202\32\232\360`\320\203\1"
  "\247\42\214\266\271T*\315$\243F\214$xH\311\230T\307\20\215X\203\256\344\20QC\306\20It"
  "\6\0\250\13h\364\253!D\304\20#\3\251/\61\26\322fR\331D\42\207\10\42#D\214\31\62b"
  "\206\220\21\71F\344\30\221c\304\14\21!\4\211\10\61F\206\10\25\63n\30\211\202\247\0\252\14\346T"
  "\247\62\302\314\210#($\253\33\214U\276\25\221\64\223\214!\61\206\304\30\42c\306\220\31Cf\320\230"
  "ARE\254\11\253t\272\360\340\244\14\255\10h\330\272\360 \1\256\62\61\26\322fR\331D\42\207\10"
  "\61#D\310\31\62C\206\220\31\62f\314\241\61\246\306\214\30#B\310\20\61\42\204L\61D\250\230q"
  "\303H\24<\5\0\257\10H\364\253\360 \0\260\20\350T\253B\306\204\30\21\202\310()\2\0\261\20"
  "\353\25\272\64pF\17\16\15\234=\204*\24\262\17\7\25\243QB\210\210\60\242\304L\343\0\263\16\7"
  "\25\243`\302\314 \62\244R\230\0\264\13\206\324\247\63\204\304\220\61\0\265\21,z\275\60\352\376*\305"
  "\3\23#N\316%\0\266&k\326\271\203\342\201\220<\21aDH\21AC\4\15\21\64D\320\20A"
  "C\4\15\21\64D\320\20AC\4\15\21\267\13\246\264\242A\342\201\20\22\0\270\15\305t\235\22F\314"
  "\220\20bL\0\271\11\5\21\233\62\42\215<\272\15\346T\247A\2\11%\42\212\214\0\273\37\215U\276"
  " *\324 Ad\6\221\31Df\320\64d\206\220\31Bf\10\231\211\244\12\5\0\274.\61\22\312-"
  "h\334\30bc\212\211\23%P\320@\61#\305\10\25\42|\314\270A\343\4\21\23$B\324 \21\202"
  "\6!\21vB\250\20\0\275-\61\22\312-h\334\30bc\212\211\23%P\320@\61#\305\10\25\42"
  "|H\261!#\204\211\21\42J\240\240q\202\206\215\22vB\334\1\276/\62\26\322.\304\334\20s\242"
  "\306\11#\65\214\320\310\61\302\314\210\63\62|\320@A\344\4\211\20\66f\204\250ABD\11B#\354"
  "\310P\21\0\277\31,v\265\64rz`#\7\222#H\216\302Q\247\320\220X\202\60\30\0\300%\320"
  "\22\306\64\232\370\364\240\11\227-jt\304@\22\3\207\220\33\63l\320\260Q\63b\324\304\311@\22#"
  "O\16\301&\320\22\306*\270\354\340\361\240\11\227-jt\304@\22\3\207\220\33\63l\320\260Q\63b"
  "\324\304\311@\22#O\16\302'\320\22\306\30\232\254\311\61\342\301\22.[\324\350\210\201$\6\16!\67"
  "f\330\240a\243f\304\250\211\223\201$F\236\34\303'\260\22\306EB\344I\21\343\1\23.[\324\350"
  "\210\201$\6\16!\67f\330\240a\243f\304\250\211\223\201$F\236\34\304)\260\22\306\64F\340\220\201"
  "c\304\203%\134\266\250\321\21\3I\14\34Bn\314\260A\303F\315\210Q\23'\3I\214<\71\0\305"
  "'\320\22\306'\232\260\210\320\343A\23.[\324\350\210\201$\6\16!\67f\330\240a\243f\304\250\211"
  "\223\201$F\236\34\306\42\66\22\336\330\360\335\263\363\0F\14'\61|\310h\42\253\306,\42\263h\332"
  "M\231\16{\20\354\35\3\307 \316v\301tJ\321\22R$\306]J\357F\214\33A\212D\223U'"
  "\3\223\15\21Z$)\0\310\27\314\32\276\42\222\350\364@V<`\71\313\25[\214\234\345\203\7\6\311"
  "\30\314\32\276\67\220\334\300\361@V<`\71\313\25[\214\234\345\203\7\6\312\30\314\32\276\25\262\330\241"
  "\61\303W<`\71\313\25[\214\234\345\203\7\6\313\32\254\32\276\61F\320\30Ac\304\3X\361\200\345"
  ",Wl\61r\226\17\36\30\314\16\306\16\236!\246\314\240\221c\346\377\17\315\17\306\32\236\63\204\304\220"
  "\221c\346\377o\0\316\20\310\22\236\23\252\310\11\61CG\315\377\337\0\317\16\250\22\236 \246\232\241\243"
  "\346\377o\0\320#\60\22\306\222\216Q\33Rd\210\21!F\204\30\11\64\335\20!F\204\30\21bD"
  "H\221i\303H\21\0\321#\255\32\306\64B\330\61\21\343\201\214;v\14U\242DjL\214\61\62\304"
  "\10\11\63#\14e\205\354\272\1\322\36\316\26\306\63\226\360\364\0\215)ZB\212\304\60t\367\335\210q"
  "#H\221`\263\352\14\0\323\37\316\26\306)\264\344\320\361\0\215)ZB\212\304\60t\367\335\210q#"
  "H\221`\263\352\14\0\324 \316\26\306\27\226\244\271\61\342\201\31S\264\204\24\211a\350\356\273\21\343F"
  "\220\42\301f\325\31\0\325 \256\26\306DB\334\71\21\343\301\31S\264\204\24\211a\350\356\273\21\343F"
  "\220\42\301f\325\31\0\326!\256\26\306\63F\330\30ac\304\3\63\246h\11)\22\303\320\335w#\306"
  "\215 E\202\315\252\63\0\327\33\214U\272\22,\314\240\21EJ\250Ae\314\24\32\25EJ\14\32\23"
  ",\10\0\330&\61\22\306f\62\335*\212\210\215\10\62\256\310\250#c\320\270\71C\342\24\211r$B"
  "\214\33D\212\24\63\205\247\0\331\25\315\32\306#\264\350\330\361`\306\331\377\335)\22K\26\235\1\332\25"
  "\315\32\306\70\222\340\310\361`\306\331\377\335)\22K\26\235\1\333\27\315\32\306\26\264\334\251\61\343\1\214"
  "\263\377\273S$\226,:\3\0\334\30\255\32\306#f\224\230Qb\306\3\30g\377w\247H,Yt"
  "\6\0\335\37\316\26\302\70\224$\365\200\6\32<\66\204\20\231A\203\210\220\32\62\14\235A\223D\351+"
  "\0\336\30-\32\302\60t\322DKX\14\273\316\330\261\7!\226$\32:)\0\337%,\32\276b*"
  "I\211\22\243F\214\32\61j\304 \22#\214\214\60\62\210\304\250[\215\30Sb\204\221\21e\0\340\31"
  "K\26\272A\220J\361\200\206!Q\61h\340(#nLY\364\302\304\0\341\30K\26\272F\335\364\200"
  "\206!Q\61h\340(#nLY\364\302\304\0\342\33K\26\272\64\256\324\210A\322\203\30\206D\305\240"
  "\201\243\214\270\61e\321\13\23\3\343\32+\26\272c\350\220\20\361`\206!Q\61h\340(#nLY"
  "\364\302\304\0\344\34K\26\272\62D\320\20AC\304\203\36\206D\305\240\201\243\214\270\61e\321\13\23\3"
  "\345\33K\26\272\64\60\204\70\202\342\1\15C\242b\320\300QF\334\230\262\350\205\211\1\346$\264\25\332"
  "\64l\330\203\60\17\206\14\42\64r\324\60SD\36\240y\65r\24)\21\203\312\220\310\344\214\31\0\347"
  "\34Lv\271\64\16\215\222A\210N\316\222\20\11\42D\24\31\14:\62\204\330\200\204\0\350\35L\26\272"
  "\62\222\350P\361\300\210\241Q\62h\304\250c\17^\222\32\61hL\42\63\0\351\35L\26\272\67\220\334"
  "H\361\300\210\241Q\62h\304\250c\17^\222\32\61hL\42\63\0\352\36L\26\272%\222\234)A\342"
  "\301\20C\243d\320\210Q\307\36\274$\65b\320\230Df\0\353\37L\26\272#D\324\220AC\306C"
  "@\14\215\222A#F\35{\360\222\324\210Ac\22\231\1\354\15F\16\232\60h\366\0\306\314\377\0\355"
  "\17F\32\232B\202\22\361 \306\314\377\6\0\356\21H\16\232#\252\310\10\211\304\3\32\65\377\23\0\357"
  "\21H\16\232!D\304\20#\343\1\217\232\377\11\0\360\35,\26\272C\222\204\60S\246F\220\34\204d"
  "\5\221D\307,;D\202\10\221Tf\0\361\31,\32\276\63B\324)!\342\201\15R\262\202\14\211Q"
  "#F\335\257F\0\362\31L\26\272\62t\366\240\210\241Q\62\10\225\61\233\35\42Af\210\42\63\0\363"
  "\33L\26\272\67\220\334H\361\300\210\241Q\62\10\225\61\233\35\42Af\210\42\63\0\364\34L\26\272%"
  "\222\234)A\342\301\20C\243d\20*c\66;D\202\314\20Ef\0\365\33,\26\272s\312\224\220\361"
  "\200\210\241Q\62\10\225\61\233\35\42Af\210\42\63\0\366\35L\26\272#D\324\220AC\306C@\14"
  "\215\222A\250\214\331\354\20\11\62C\24\231\1\367\20\213\65\266\64pz\260\17\316\203\35\70\21\0\370\35"
  "\257\21\276\66\22\231\252QEF\25\31S\246\311\21\22\206\206\224\32D\206T\272C\0\371\26L\26\276"
  "Br\350\364\240I\335\257F\214\32A\244\304\232\22\3\372\25L\26\276G\341\364\240I\335\257F\214\32"
  "A\244\304\232\22\3\373\30L\26\276\65\260\330\210A\322\203%u\277\32\61j\4\221\22kJ\14\374\30"
  "L\26\276#\325\210Q#\306CH\352~\65b\324\10\42%\326\224\30\375&\354v\271\67\220\334H\361"
  "\300\207\31\33\61h\310\240!D\6\15\31\64\202\224\61s\4\11\216\34Hp\344\300q\0\376\35\314z"
  "\275\60rN\6)YA\206\304\250\21\243\356jD\25JF\224\31\71K\241\0\377(\354v\271#D"
  "\324\220AC\306C\70\314\330\210AC\6\15!\62h\310\240\21\244\214\231#Hp\344@\202#\7\216"
  "\3\0\0\0\4\377\377\0";


// for the display
// this uses the default SPI interface as defined by the manufacturer
// NOTE: for the Adafruit HUZZAH32, use the *labelled pins*, not the standard ones for the ESP32
U8G2_SSD1322_NHD_256X64_F_4W_HW_SPI u8g2(U8G2_R2, SCREEN_CS, SCREEN_DC, SCREEN_RST);
uint32_t screenTimer = 0;

#define SCREEN_HEIGHT 64
#define SCREEN_WIDTH 256

void Display::begin() {
//start the screen object
  u8g2.begin();
}

void Display::loop() {
  if ((screenTimer > 0) && (millis() > screenTimer + SCREEN_TIMEOUT)) {
    Display::dimScreen();
  }
}

//function that puts the input and volume on the screen
void Display::updateScreen() {
  char volume [5];
  if ((muteState == 0) && sysSettings.volume > 0) {
    uint16_t v = round(((float)sysSettings.volume / (float)VOL_MAX) * 100);
    itoa(v, volume, 10);
    strcat(volume, "%");
  } else {
    String s = "MUTE";
    strcpy(volume, s.c_str());
  }
  u8g2.clearBuffer();					// clear the internal memory

  //u8g2.setFont(u8g2_font_fub25_tf);
  //u8g2.setFont(u8g2_font_logisoso22_tf);
  u8g2.setFont(rubik_24_f);

  //vertically centers the text
  uint16_t y = 40;
  //left starting position for the volume (so it's right-aligned)
  uint16_t x = SCREEN_WIDTH - u8g2.getStrWidth(volume);

  u8g2.drawStr(0, y, sysSettings.inputs[sysSettings.input - 1].name.c_str());
  u8g2.drawStr(x, y, volume);

  u8g2.setFont(u8g2_font_crox1h_tr);
  x = SCREEN_WIDTH - u8g2.getStrWidth("VOLUME");
  u8g2.drawStr(0, SCREEN_HEIGHT, "INPUT");
  u8g2.drawStr(x, SCREEN_HEIGHT, "VOLUME");

  //include an icon for the wifi access point / wifi_connected
  if (_access_point == true) {
    u8g2.setFont(u8g2_font_open_iconic_www_1x_t);
    u8g2.drawGlyph(124,9,0x48);
  }

  //max brightness
  u8g2.setContrast(255);
  //write data to screen
  u8g2.sendBuffer();
  //dim the display in 10s
  if (sysSettings.dim == 1) {
    screenTimer = millis();
  }
}

void Display::wifiScreen(const char* ssid) {
  u8g2.clearBuffer();					// clear the internal memory

  u8g2.setFont(u8g2_font_open_iconic_www_2x_t);
  u8g2.drawGlyph(120,19,0x48);

  u8g2.setFont(u8g2_font_crox1h_tr);
  String string = "Search for this WiFi network";
  const char* str = string.c_str();
  uint16_t x = 128 - (u8g2.getStrWidth(str) / 2);
  uint16_t y = 45;
  u8g2.drawStr(x, y, str);

  u8g2.setFont(u8g2_font_Born2bSportyV2_tr);
  x = 128 - (u8g2.getStrWidth(ssid) / 2);
  y = SCREEN_HEIGHT;
  u8g2.drawStr(x, y, ssid);

  u8g2.setContrast(255);
  u8g2.sendBuffer();
}

//called after the timeout elapses, drops screen brightness
void Display::dimScreen() {
  u8g2.setContrast(1);
  screenTimer = 0;
}

void Display::off() {
  u8g2.setPowerSave(1);
}

void Display::setAPMode(bool mode) {
  _access_point = mode;
  if (mode == false) {
    Display::updateScreen();
  }
}

void Display::wifiConnected(bool state) {
  _wifi_state = state;
}